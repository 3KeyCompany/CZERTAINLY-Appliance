#!/bin/bash

set -e

mkdir -p /etc/ansible/vars
chgrp -R adm /etc/ansible/vars
chmod -R +w,g+w /etc/ansible/vars
chmod g+s /etc/ansible/vars

chmod +x /usr/local/bin/customize4developer.sh
chmod +x /usr/local/bin/czertainly-tui.sh

chmod 0440 /etc/sudoers.d/czertainly

# We need SCP so we can't change shell. File .bashrc is used only in
# interactive mode.
echo "
. /etc/ansible/exec-tui
" >> /home/czertainly/.bashrc

git clone {{ ansible_roles.branding.repo }} /etc/ansible/roles/branding
cd /etc/ansible/roles/branding
git checkout {{ ansible_roles.branding.branch }}

git clone {{ ansible_roles.host_config.repo }} /etc/ansible/roles/host-config
cd /etc/ansible/roles/host-config
git checkout {{ ansible_roles.host_config.branch }}

git clone {{ ansible_roles.rke2.repo }} /etc/ansible/roles/rke2
cd /etc/ansible/roles/rke2
git checkout {{ ansible_roles.rke2.branch }}

git clone {{ ansible_roles.czertainly.repo }} /etc/ansible/roles/czertainly
cd /etc/ansible/roles/czertainly
git checkout {{ ansible_roles.czertainly.branch }}

# during installation is $HOME variable set to / so ansible-galaxy
# installs into /
HOME=/root ansible-galaxy collection install kubernetes.core

ansible-playbook /etc/ansible/playbooks/czertainly-branding.yml
